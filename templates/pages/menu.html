{% extends "base.html" %}
{% load static %}
{% block title %} Blue Sky Summer - Menu{% endblock title %}

{% block content %}

<div class="products">
    <div class="heading" style="margin-top:0;">
        <h1>Our Latest Flavours</h1>
        <img src="{% static 'image/separator-img.png' %}" alt="Separator Image">
    </div>

    <div class="box-container">

        {% if products %}
            {% for product in products %}

            <form action="" method="post"
                class="box {% if product.product_stock == 0 %}disabled{% endif %}"
                onclick="window.location.href='{% url 'view_product' product.id %}'">

                {% csrf_token %}

                <!-- Product Image -->
                <img src="{{ product.product_image.url }}" alt="{{ product.product_name }}" class="image">

                <!-- Stock Badge -->
                {% if product.product_stock > 9 %}
                    <span class="stock" style="color: green;">In Stock</span>
                {% elif product.product_stock == 0 %}
                    <span class="stock" style="color: red;">Out of Stock</span>
                {% else %}
                    <span class="stock" style="color: red;">Hurry, only {{ product.product_stock }} left!</span>
                {% endif %}

                <!-- ❤️ Wishlist Button (top-right) -->
                <button class="wishlist-btn"
                        type="button"
                        onclick="event.stopPropagation(); toggleWishlist(this, '{{ product.id }}')">

                    {% if product.is_in_wishlist %}
                        <i class='bx bxs-heart'></i>   <!-- FILLED HEART -->
                    {% else %}
                        <i class='bx bx-heart'></i>    <!-- OUTLINE HEART -->
                    {% endif %}
                </button>

                <!-- Content -->
                <div class="content">
                    <img src="{% static 'image/shape-19.png' %}" alt="Shape Image" class="shap">

                    <div class="button">
                        <div><h3 class="name">{{ product.product_name }}</h3></div>
                    </div>

                    <p class="price">Price: ₹{{ product.product_price }}</p>

                    <input type="hidden" name="product_id" value="{{ product.id }}">

                    <div class="flex-btn">

                        <!-- BUY NOW Button -->
                        <button type="button"
                                class="btn"
                                onclick="event.stopPropagation(); window.location.href='{% url 'checkout' %}?buy_now={{ product.id }}'">
                            Buy Now
                        </button>

                        <!-- ADD TO CART Button -->
                        <button type="submit"
                                name="add_to_cart"
                                formaction="{% url 'add_to_cart' product.id %}"
                                class="btn"
                                onclick="event.stopPropagation()">
                            Add to Cart
                        </button>

                    </div>
                </div>
            </form>

            {% endfor %}
        {% else %}
            <div class="empty">
                <p>No products added yet!</p>
            </div>
        {% endif %}

    </div>

    <!-- Pagination -->
    <div class="pagination">
        {% if products.has_previous %}
            <a href="?page={{ products.previous_page_number }}" class="btn">Prev</a>
        {% endif %}

        <span class="page-info"> Page {{ products.number }} of {{ products.paginator.num_pages }} </span>

        {% if products.has_next %}
            <a href="?page={{ products.next_page_number }}" class="btn">Next</a>
        {% endif %}
    </div>

</div>

<script>
function toggleWishlist(btn, productId) {

    fetch("/toggle_wishlist/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}", 
        },
        body: JSON.stringify({ product_id: productId })
    })
    .then(res => res.json())
    .then(data => {

        if (data.added) {
            btn.innerHTML = "<i class='bx bxs-heart'></i>";
            Swal.fire("Added!", "Item added to wishlist.", "success");
        }

        if (data.removed) {
            btn.innerHTML = "<i class='bx bx-heart'></i>";
            Swal.fire("Removed!", "Item removed from wishlist.", "info");
        }

    })
    .catch(err => console.log("Wishlist toggle error:", err));
}
</script>


{% endblock content %}
